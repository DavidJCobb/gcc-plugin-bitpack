<!doctype html>
<html>
   <head>
      <title>Serialization list to tree</title>
      <style>
html {
   font-family: Calibri, sans-serif;
}

section {
   margin: .5em;
   border: 1px solid #000;
   
   &>header {
      background: #FF7400;
      font-weight: bold;
      
      padding:.25em .5em;
      border-bottom: 1px solid #000;
   }
   &>div {
      padding: 1em;
   }
}

section.input>div {
   textarea {
      display: block;
      width:   60em;
      height:  30em;
   }
}

.output-stage {
   border:  1px solid #000;
   padding: 1em;
   
   &:not([open]) {
      padding-top:    0;
      padding-bottom: 0;
      
      &>summary {
         margin-top: 0;
         border-bottom-width: 0;
      }
   }
   
   &+& {
      margin-top: 1em;
   }
   
   &>summary {
      padding: .5em 1em;
      margin:  -1em -1em 0 -1em;
      border-bottom: 1px solid #000;
      
      font-weight: bold;
      
      background: #444;
      color: #FFF;
   }
}
#out-rechunked {
   li {
      font-family: "Lucida Console", monospace;
      font-size:   .75rem;
      margin:      .25rem 0;
      
      span {
         display:    inline-block;
         padding:    .125em .25em;
         background; #CCC;
         border:     1px solid #888;
         
         &.condition {
            background:   #FEB;
            border-color: #A96;
         }
         &.qualified-decl {
            background:   #ADF;
            border-color: #59B;
            
            &:not(:first-child)::before {
               content: ".";
            }
         }
         &.transform-list {
            background:   #CFC;
            border-color: #6A6;
         }
         
         &+& {
            border-left: 0;
         }
      }
   }
}
#out-treed {
   li {
      font-family: "Lucida Console", monospace;
      font-size:   .75rem;
      margin:      .25rem 0;
      
      &>span {
         display:    inline-block;
         padding:    .125em .25em;
         border:     1px solid #888;
         background: #CCC;
         
         &+& {
            border-left: 0;
         }
      }
      
      &.branch-condition-value {
         &>span {
            background:   #FEB;
            border-color: #A96;
         }
      }
      
      &.single {
         &>span {
            background:   #ADF;
            border-color: #59B;
         }
      }
      &.condition {
         &>span {
            background:   #FEB;
            border-color: #A96;
         }
      }
      &.transform {
         &>span {
            background:   #CFC;
            border-color: #6A6;
         }
         &>.qualified-decl {
            background:   #ADF;
            border-color: #59B;
         }
      }
   }
}
      </style>
   </head>
   <body>
      <section class="input">
         <header>
            Input
         </header>
         <div>
            <textarea id="in">sTestStruct|a
sTestStruct|b
sTestStruct|c[0:3]
sTestStruct|d[0:3][0:2]
sTestStruct|e as Transformed_E|a
sTestStruct|e as Transformed_E|b
sTestStruct|f[0] as Transformed_F|x
sTestStruct|f[1] as Transformed_F|x
sTestStruct|tag_g
sTestStruct|data_g|(sTestStruct.tag_g == 0) a
sTestStruct|data_g|(sTestStruct.tag_g == 1) b|tag
sTestStruct|data_g|(sTestStruct.tag_g == 1) b|data|(sTestStruct.data_g.b.tag == 0) a
sTestStruct|tag_x
sTestStruct|data_x|(sTestStruct.tag_x == 0) a
sTestStruct|data_x|(sTestStruct.tag_x == 1) b
sTestStruct|data_x|(sTestStruct.tag_x == 2) c
sTestStruct|tag_y
sTestStruct|data_y[0]|(sTestStruct.tag_y == 0) a
sTestStruct|data_y[0]|(sTestStruct.tag_y == 1) b
sTestStruct|data_y[0]|(sTestStruct.tag_y == 2) c
sTestStruct|data_y[1]|(sTestStruct.tag_y == 0) a
sTestStruct|data_y[1]|(sTestStruct.tag_y == 1) b
sTestStruct|data_y[1]|(sTestStruct.tag_y == 2) c
sTestStruct|z as Transformed_Z|tag
sTestStruct|z as Transformed_Z|data|(sTestStruct.z.tag == 0) a
sTestStruct|z as Transformed_Z|data|(sTestStruct.z.tag == 0) b
sTestStruct|z[0] as Transformed_Z|tag
sTestStruct|z[0] as Transformed_Z|data|(sTestStruct.z[0].tag == 0) a
sTestStruct|z[0] as Transformed_Z|data|(sTestStruct.z[0].tag == 1) b
sTestStruct|z[1] as Transformed_Z|tag
sTestStruct|z[1] as Transformed_Z|data|(sTestStruct.z[1].tag == 0) a
sTestStruct|z[1] as Transformed_Z|data|(sTestStruct.z[1].tag == 1) b</textarea>
            <button id="go">To tree</button>
         </div>
      </section>
      <section>
         <header>
            Output
         </header>
         <div>
            <details class="output-stage" open>
               <summary>Rechunked</summary>
               <ul id="out-rechunked"></ul>
            </details>
            <details class="output-stage" open>
               <summary>Treed</summary>
               <ul id="out-treed"></ul>
            </details>
         
            <ul id="out-fully-exploded">
            </ul>
         </div>
      </section>
      <script>
{
   // I don't think I will ever *not* be salty that JavaScript assertions don't halt 
   // execution. Imagine screwing up assertions even more badly than Python, and now 
   // imagine having that screw-up cemented into your ecosystem for decades. Insane.
   let orig = console.assert;
   console.assert = function(cnd, ...args) {
      orig(cnd, ...args);
      if (!cnd)
         throw new Error("Assertion failed.");
   };
}
      </script>
      <script src="serialization_item.js"></script>
      <script src="instruction.js"></script>
      <script src="item_list_to_instruction_tree.js"></script>
      <script>
document.getElementById("go").addEventListener("click", function(e) {
   let list = [];
   {
      let data = document.getElementById("in").value.split("\n");
      for(let item of data) {
         let instance = new serialization_item();
         instance.from_string(item);
         list.push(instance);
      }
   }
   let tree = item_list_to_instruction_tree(list);
});
      </script>
   </body>
</html>